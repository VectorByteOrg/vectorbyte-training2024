<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alicia Arneson">
<meta name="dcterms.date" content="2024-07-01">

<title>VectorByte Training 2024 - VectorByte Methods Training: Introduction to Time Series Forecasting (practical)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./graphics/vblogoedit.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">VectorByte Training 2024</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./schedule2024.html"> 
<span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./materials.html"> 
<span class="menu-text">Materials</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/VectorByteOrg/vectorbyte-training2024"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/vectorbite_rcn"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview-and-instructions" id="toc-overview-and-instructions" class="nav-link active" data-scroll-target="#overview-and-instructions">Overview and Instructions</a></li>
  <li><a href="#defining-the-goal" id="toc-defining-the-goal" class="nav-link" data-scroll-target="#defining-the-goal">Defining the Goal</a></li>
  <li><a href="#getting-the-data-and-pre-processing" id="toc-getting-the-data-and-pre-processing" class="nav-link" data-scroll-target="#getting-the-data-and-pre-processing">Getting the Data and Pre-Processing</a></li>
  <li><a href="#exploring-and-visualizing-the-data" id="toc-exploring-and-visualizing-the-data" class="nav-link" data-scroll-target="#exploring-and-visualizing-the-data">Exploring and Visualizing the Data</a></li>
  <li><a href="#partitioning-the-data" id="toc-partitioning-the-data" class="nav-link" data-scroll-target="#partitioning-the-data">Partitioning the data</a></li>
  <li><a href="#modeling---woot-woot" id="toc-modeling---woot-woot" class="nav-link" data-scroll-target="#modeling---woot-woot">Modeling - <em>Woot Woot 🥳</em></a>
  <ul class="collapse">
  <li><a href="#series-decomposition-by-loess-arima-or-exponential-smoothing" id="toc-series-decomposition-by-loess-arima-or-exponential-smoothing" class="nav-link" data-scroll-target="#series-decomposition-by-loess-arima-or-exponential-smoothing">Series Decomposition by Loess + ARIMA or Exponential Smoothing</a></li>
  <li><a href="#linear-regression" id="toc-linear-regression" class="nav-link" data-scroll-target="#linear-regression">Linear Regression</a>
  <ul class="collapse">
  <li><a href="#applying-arima-to-the-residual-series-arima-as-a-second-layer-model" id="toc-applying-arima-to-the-residual-series-arima-as-a-second-layer-model" class="nav-link" data-scroll-target="#applying-arima-to-the-residual-series-arima-as-a-second-layer-model">Applying ARIMA to the residual series (ARIMA as a second-layer model)</a></li>
  </ul></li>
  <li><a href="#generalized-additive-models-gams" id="toc-generalized-additive-models-gams" class="nav-link" data-scroll-target="#generalized-additive-models-gams">(Generalized) Additive Models (GAMs)</a></li>
  <li><a href="#time-varying-coefficient-ar-model" id="toc-time-varying-coefficient-ar-model" class="nav-link" data-scroll-target="#time-varying-coefficient-ar-model">Time-Varying Coefficient AR Model</a></li>
  <li><a href="#neural-network" id="toc-neural-network" class="nav-link" data-scroll-target="#neural-network">Neural Network</a></li>
  <li><a href="#an-easy-ensemble" id="toc-an-easy-ensemble" class="nav-link" data-scroll-target="#an-easy-ensemble">An Easy Ensemble</a></li>
  </ul></li>
  <li><a href="#evaluate-and-compare-performance" id="toc-evaluate-and-compare-performance" class="nav-link" data-scroll-target="#evaluate-and-compare-performance">Evaluate and Compare Performance</a>
  <ul class="collapse">
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next Steps</a></li>
  </ul></li>
  <li><a href="#your-turn" id="toc-your-turn" class="nav-link" data-scroll-target="#your-turn">Your Turn!</a>
  <ul class="collapse">
  <li><a href="#challenge-details" id="toc-challenge-details" class="nav-link" data-scroll-target="#challenge-details">Challenge Details</a>
  <ul class="collapse">
  <li><a href="#the-data-set" id="toc-the-data-set" class="nav-link" data-scroll-target="#the-data-set">The Data Set</a></li>
  <li><a href="#hints" id="toc-hints" class="nav-link" data-scroll-target="#hints">Hints</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">VectorByte Methods Training: Introduction to Time Series Forecasting (practical)</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Alicia Arneson </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Virginia Tech and VectorByte
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 1, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p><br></p>
<section id="overview-and-instructions" class="level1">
<h1>Overview and Instructions</h1>
<p>The goals of this practical are to:</p>
<ol type="1">
<li><p>Practice setting up data for forecasting</p></li>
<li><p>Practice fitting time series models for forecasting</p></li>
<li><p>Practice generating forecasts for a given model and evaluating its performance</p></li>
<li><p>Learn aggressively…. See the forecasting challenge section below :)</p></li>
</ol>
<p><br></p>
<p>This practical will take you through an example of modeling a terrestrial phenology (how much greenness can be observed from above) data set from NEON and generating forecasts from the best model. Then, we will have the world’s smallest (and fastest) forecasting competition for you to practice your skills via trial by fire, because everyone learns best under pressure! :)</p>
</section>
<section id="defining-the-goal" class="level1">
<h1>Defining the Goal</h1>
<section id="slide-4" class="level4">
<h4 class="anchored" data-anchor-id="slide-4">Slide 4</h4>
<p>The first step of forecasting is to define the forecasting goal - why the heck are you about to spend several hours of your life gathering data and modeling it?? Also, once you know that - how are you going to do it?</p>
<p>This process can sometimes take a really long time (even a year or more) for large forecasting projects. It often involves a team of people who have some kind of stake in the forecasting process or results.</p>
<p>In our case, it will just take however much time you need to read the following sentence. The goals of our forecasting exercise are to (1) Practice the forecasting process and (2) Generate 30 day out forecasts for tree greenness using data provided by the NEON Forecasting Challenge and publicly available weather data.</p>
</section>
</section>
<section id="getting-the-data-and-pre-processing" class="level1">
<h1>Getting the Data and Pre-Processing</h1>
<section id="slide-5-7" class="level4">
<h4 class="anchored" data-anchor-id="slide-5-7">Slide 5 &amp; 7</h4>
<p>This data set originally required some cleaning and wrangling. The version you have <a href="data/NEONphenologyClean.csv">NEONphenologyClean.csv</a> is ready to explore and model! However, the cleaning process is shown here in case you ever need to do something like this on your own. **This section is optional to look through.**</p>
<p><em>Note: there are more automated ways to pull weather data for your future forecasting for better reproducibility, but I ran out of time to make code like that for our use</em>.</p>
<ol type="1">
<li><p>The data set was compiled from two separate data sets: the phenology data set for the HARV site from the NEON website and publicly available weather data from a nearby airport retrieved from NOAA’s website.</p>
<p><strong>NOAA Data:</strong> phenologyWeather.csv (taken from: https://www.ncei.noaa.gov/cdo-web/)</p>
<p><strong>NEON Phenology Data:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://sdsc.osn.xsede.org/bio230014-bucket01/challenges/targets/project_id=neon4cast/duration=P1D/phenology-targets.csv.gz"</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>phenology_targets <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(url, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>phenology <span class="ot">&lt;-</span> phenology_targets <span class="sc">%&gt;%</span> <span class="fu">filter</span>(site_id <span class="sc">==</span> <span class="st">"HARV"</span> <span class="sc">&amp;</span> variable <span class="sc">==</span> <span class="st">"gcc_90"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>The NEON data set needed some imputation, which was done using a centered moving average approach. A nice package called <code>imputeTS</code> is available in R to do this kind of imputation quickly. The package contains several more advanced imputation methods as well, but we kept it straightforward for this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(imputeTS)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>phenology<span class="sc">$</span>update <span class="ot">&lt;-</span> <span class="fu">na_ma</span>(phenology<span class="sc">$</span>observation, <span class="at">k =</span> <span class="dv">6</span>, <span class="at">weighting =</span> <span class="st">"exponential"</span>, <span class="at">maxgap =</span> <span class="cn">Inf</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>phenology <span class="ot">&lt;-</span> phenology <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">observation =</span> <span class="fu">coalesce</span>(observation, update))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>The NOAA data needed to be summarized from hourly measurements to daily summaries and lagged predictors were added to the data set as well.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read it in from the file</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>weather <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/phenologyWeather.csv"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean it up and add necessary variables</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>weather<span class="sc">$</span>DATE<span class="ot">&lt;-</span> <span class="fu">ymd</span>(weather<span class="sc">$</span>DATE)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>weather<span class="sc">$</span>iso_week <span class="ot">&lt;-</span> <span class="fu">isoweek</span>(weather<span class="sc">$</span>DATE)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>weather<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">year</span>(weather<span class="sc">$</span>DATE)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>weather<span class="sc">$</span>iso_week <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(weather<span class="sc">$</span>iso_week)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>weather<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(weather<span class="sc">$</span>year)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>weather<span class="sc">$</span>HourlyDryBulbTemperature <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(weather<span class="sc">$</span>HourlyDryBulbTemperature)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>weather<span class="sc">$</span>HourlyRelativeHumidity <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(weather<span class="sc">$</span>HourlyRelativeHumidity)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>weather<span class="sc">$</span>HourlyPrecipitation <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(weather<span class="sc">$</span>HourlyPrecipitation)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>weather<span class="sc">$</span>HourlyWindSpeed <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(weather<span class="sc">$</span>HourlyWindSpeed)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the variables to a daily timescale to match the data set</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>weatherSum <span class="ot">&lt;-</span> weather <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(DATE) <span class="sc">%&gt;%</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">meanTemp =</span> <span class="fu">mean</span>(HourlyDryBulbTemperature, </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>                            <span class="at">na.rm =</span> T),</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">minTemp =</span> <span class="fu">min</span>(HourlyDryBulbTemperature, </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>                          <span class="at">na.rm =</span> T),</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>            <span class="at">maxTemp =</span> <span class="fu">max</span>(HourlyDryBulbTemperature, </span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>                          <span class="at">na.rm =</span> T),</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>            <span class="at">meanRH =</span> <span class="fu">mean</span>(HourlyRelativeHumidity, <span class="at">na.rm =</span> T),</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>            <span class="at">minRH =</span> <span class="fu">min</span>(HourlyRelativeHumidity, <span class="at">na.rm =</span> T),</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">maxRH =</span> <span class="fu">max</span>(HourlyRelativeHumidity, <span class="at">na.rm =</span> T),</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">totalPrecipitation =</span> <span class="fu">sum</span>(HourlyPrecipitation,</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">na.rm =</span> T),</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>            <span class="at">meanWindSpeed =</span> <span class="fu">mean</span>(HourlyWindSpeed, <span class="at">na.rm =</span> T),</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>            <span class="at">maxWindSpeed =</span> <span class="fu">max</span>(HourlyWindSpeed, <span class="at">na.rm =</span> T))</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="do">## Add one day back lags (you would probably want some others, but we'll keep it simple). The "ungroup()" step here is crucial or the lags will be grouped by date, which makes no sense.</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    weatherSum <span class="ot">&lt;-</span> weatherSum <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">meanTempLag1 =</span> <span class="fu">lag</span>(meanTemp, <span class="dv">1</span>),</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">minTempLag1 =</span> <span class="fu">lag</span>(minTemp, <span class="dv">1</span>),</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">maxTempLag1 =</span> <span class="fu">lag</span>(maxTemp, <span class="dv">1</span>),</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">meanRHLag1 =</span> <span class="fu">lag</span>(meanRH, <span class="dv">1</span>),</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">minRHLag1 =</span> <span class="fu">lag</span>(minRH, <span class="dv">1</span>),</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">maxRHLag1 =</span> <span class="fu">lag</span>(maxRH, <span class="dv">1</span>),</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">totalPrecipitationLag1 =</span> <span class="fu">lag</span>(totalPrecipitation, <span class="dv">1</span>),</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">meanWindSpeedLag1 =</span> <span class="fu">lag</span>(meanWindSpeed, <span class="dv">1</span>),</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">maxWindSpeedLag1 =</span> <span class="fu">lag</span>(maxWindSpeed, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="4" type="1">
<li>The two cleaned up data sets were merged together.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the date names match for easy merging</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>phenology<span class="sc">$</span>DATE <span class="ot">&lt;-</span> phenology<span class="sc">$</span>datetime</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the full data set!</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>phenWithWeather <span class="ot">&lt;-</span> <span class="fu">merge</span>(phenology, weatherSum, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"DATE"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="exploring-and-visualizing-the-data" class="level1">
<h1>Exploring and Visualizing the Data</h1>
<section id="slide-6" class="level4">
<h4 class="anchored" data-anchor-id="slide-6">Slide 6</h4>
<p>A simple plot of the time series can go a long way in telling us what kinds of patterns are present. We can already see some strong evidence of seasonality and maybe a slight trend.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the clean data set</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>phen <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/NEONphenologyClean.csv"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.0     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> phen, <span class="fu">aes</span>(<span class="at">x =</span> DATE, <span class="at">y =</span> observation))<span class="sc">+</span>   </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>We can explore some of the predictors we have available as well to see if the patterns in the predictors match up. Temperature seems to share a similar seasonal pattern to our variable of interest. Take some time here and explore some of the other predictors to see how they might match up.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> phen, <span class="fu">aes</span>(<span class="at">x =</span> DATE, <span class="at">y =</span> meanTemp))<span class="sc">+</span>   </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Decomposition plots and autocorrelation plots are also useful tools to help us prepare to fit appropriate forecasting models. In order to make a decomposition plot, we have to formally declare that the data are a time series by turning them into a time series object in R. We do that by using the <code>ts()</code> function. Several of the more basic time series models also require (or at least prefer) data to be in this format. Within the <code>ts()</code> function, we need to specify a frequency. The documentation does a good job of explaining what frequency is:</p>
<p>“Argument <code>frequency</code> indicates the sampling frequency of the time series, with the default value <code>1</code> indicating one sample in each unit time interval. For example, one could use a value of <code>7</code> for <code>frequency</code> when the data are sampled daily, and the natural time period is a week, or <code>12</code> when the data are sampled monthly and the natural time period is a year.”</p>
<p>Given that definition, we can set the frequency here to 365 because the repeating period for trees losing their leaves and greening back up is roughly one year and we have daily observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>phenTS <span class="ot">&lt;-</span> <span class="fu">ts</span>(phen<span class="sc">$</span>observation, <span class="at">frequency =</span> <span class="dv">365</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The decomposition plot shows that there may be a small trend in the series. It also confirms our intuition that seasonality is present.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>phenDecomp <span class="ot">&lt;-</span> <span class="fu">decompose</span>(phenTS) </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(phenDecomp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The autocorrelation plot shows that there seems to be multiple levels of autocorrelation occurring in the series. On one hand, the series is pretty sticky for nearly 100 days out. On the other hand, the direction of the correlation reverses for certain lags. This also supports the presence of both a trend and seasonal pattern.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(phen<span class="sc">$</span>observation, <span class="at">lag.max =</span> <span class="dv">365</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="partitioning-the-data" class="level1">
<h1>Partitioning the data</h1>
<section id="slide-8" class="level4">
<h4 class="anchored" data-anchor-id="slide-8">Slide 8</h4>
<p>Remember, when your goal is forecasting, data partitioning should not be done randomly. The earlier observations in the data set will be used for training and the remaining observations will be held back as a test set. Generally speaking, it is good to try to match the intended forecasting horizon with the size of the test set. The NEON challenge goal is to forecast at least 30 days out, so we will hold back 30 days of data (i.e.&nbsp;the most recent 30 observations).</p>
<p>There are probably packages out there that can do this for you, so feel free to explore other ways of achieving this kind of partitioning!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(phen)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The length of the data set minus the most recent 30 days</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>trainN <span class="ot">&lt;-</span> n<span class="dv">-30</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>testN <span class="ot">&lt;-</span> trainN<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Index the earlier rows for training</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> phen[<span class="dv">1</span><span class="sc">:</span>trainN,] </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Index the later 30 for testing</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> phen[testN<span class="sc">:</span>n,]</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(test) <span class="co"># Should be 30</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 30</code></pre>
</div>
</div>
</section>
</section>
<section id="modeling---woot-woot" class="level1">
<h1>Modeling - <em>Woot Woot 🥳</em></h1>
<p>We discussed several kinds of models during the lecture. There are many more model types out there that you may encounter, but this set should get you a good start and will provide you with the foundation you need to continue learning on your own should you need to.</p>
<p>In each section, we will fit the model to the training set, generate forecasts to compare to the test set, and generate RMSE and MAE for each model on its test set performance to evaluate each one and compare them in the next section.</p>
<section id="series-decomposition-by-loess-arima-or-exponential-smoothing" class="level2">
<h2 class="anchored" data-anchor-id="series-decomposition-by-loess-arima-or-exponential-smoothing">Series Decomposition by Loess + ARIMA or Exponential Smoothing</h2>
<section id="slide-22-27-40-43" class="level4">
<h4 class="anchored" data-anchor-id="slide-22-27-40-43">Slide 22-27 &amp; 40-43</h4>
<p>In this approach the time series is first de-trended and de-seasonalized using loess smoothing. Then the remaining stationary series is modeled using ARIMA (or another method if we select a different one). The ARIMA part is fitted via an automated process in the background so we do not have to manually specify p, d, and q. For more information about this process, see the documentation for the <code>auto.arima()</code> function.</p>
<p>If you want to try out exponential smoothing, you will use <code>method = "ETS"</code> and you can specify different model types using <code>etsmodel = "ANN"</code> for example. Other potential models can be found in the lecture slides (e.g.&nbsp;“MNN”, “AAA”, etc.). Note that because we have de-trended and de-seasonalized the series, we do not really need the latter two letters to change from “N”.</p>
<p>First, we have to turn our training data into a time series object like we did with the whole series for plotting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 method overwritten by 'quantmod':
  method            from
  as.zoo.data.frame zoo </code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># STL requires a UNIVARIATE time series object</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>ts.train <span class="ot">&lt;-</span> <span class="fu">ts</span>(train<span class="sc">$</span>observation, <span class="at">frequency =</span> <span class="dv">365</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below you can see the output for the STL + ARIMA model. The ETS version is commented out here, but you can try it out on your machine.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">## There are several options that we can customize in the stl() function, but the one we have to specify is the s.window. Check out the documentation and play around with some of the other options if you would like.</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>stl.fit <span class="ot">&lt;-</span> <span class="fu">stlm</span>(ts.train, <span class="at">s.window =</span> <span class="st">"periodic"</span>, </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">method =</span> <span class="st">"arima"</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="do">##stl.fit &lt;- stlm(ts.train, s.window = "periodic", </span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="do">##                method = "ets",</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="do">##                etsmodel = "ANN")</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(stl.fit<span class="sc">$</span>model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: x 
ARIMA(0,1,3) 

Coefficients:
          ma1      ma2     ma3
      -0.3263  -0.1179  0.0410
s.e.   0.0257   0.0259  0.0263

sigma^2 = 3.873e-05:  log likelihood = 5590.98
AIC=-11173.95   AICc=-11173.92   BIC=-11152.63

Training set error measures:
                       ME        RMSE         MAE         MPE     MAPE
Training set 1.262983e-05 0.006215367 0.004032053 -0.01602335 1.078008
                  MASE        ACF1
Training set 0.3462004 0.001065878</code></pre>
</div>
</div>
<p>Let’s look at the residuals to see if there is anything left unaccounted for.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Check for leftover autocorrelation in the residuals</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(stl.fit<span class="sc">$</span>residuals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## These models still do assume normal residuals - these look good!</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(stl.fit<span class="sc">$</span>residuals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now that we are comfortable with the model set up, we can generate forecasts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">## We can generate forecasts with the forecast() function in the forecast package</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>stl.forecasts <span class="ot">&lt;-</span> <span class="fu">forecast</span>(stl.fit, <span class="at">h =</span> <span class="dv">30</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="do">## The forecast function gives us point forecasts, as well as prediction intervals</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>stl.forecasts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         Point Forecast     Lo 80     Hi 80     Lo 95     Hi 95
5.186301      0.4472946 0.4393188 0.4552704 0.4350967 0.4594925
5.189041      0.4531159 0.4434988 0.4627330 0.4384079 0.4678240
5.191781      0.4476411 0.4370512 0.4582309 0.4314453 0.4638368
5.194521      0.4406500 0.4290394 0.4522606 0.4228931 0.4584069
5.197260      0.4452514 0.4327028 0.4578000 0.4260600 0.4644428
5.200000      0.4423128 0.4288916 0.4557340 0.4217868 0.4628388
5.202740      0.4429717 0.4287313 0.4572122 0.4211928 0.4647506
5.205479      0.4375731 0.4225581 0.4525882 0.4146096 0.4605367
5.208219      0.4404230 0.4246714 0.4561746 0.4163330 0.4645130
5.210959      0.4468553 0.4304001 0.4633106 0.4216892 0.4720214
5.213699      0.4412252 0.4240952 0.4583552 0.4150272 0.4674232
5.216438      0.4444451 0.4266659 0.4622242 0.4172542 0.4716359
5.219178      0.4360549 0.4176495 0.4544603 0.4079063 0.4642035
5.221918      0.4397223 0.4207112 0.4587333 0.4106474 0.4687972
5.224658      0.4513696 0.4317716 0.4709676 0.4213971 0.4813422
5.227397      0.4438545 0.4236866 0.4640224 0.4130104 0.4746986
5.230137      0.4433468 0.4226248 0.4640689 0.4116552 0.4750385
5.232877      0.4429392 0.4216774 0.4642011 0.4104220 0.4754564
5.235616      0.4404891 0.4187008 0.4622773 0.4071668 0.4738113
5.238356      0.4491964 0.4268942 0.4714986 0.4150881 0.4833047
5.241096      0.4469288 0.4241242 0.4697334 0.4120521 0.4818054
5.243836      0.4396761 0.4163800 0.4629723 0.4040477 0.4753046
5.246575      0.4386110 0.4148334 0.4623886 0.4022463 0.4749757
5.249315      0.4388684 0.4146189 0.4631178 0.4017821 0.4759547
5.252055      0.4363757 0.4116635 0.4610880 0.3985816 0.4741699
5.254795      0.4401331 0.4149665 0.4652997 0.4016441 0.4786221
5.257534      0.4372529 0.4116401 0.4628658 0.3980814 0.4764244
5.260274      0.4355078 0.4094563 0.4615593 0.3956655 0.4753501
5.263014      0.4369713 0.4104885 0.4634542 0.3964693 0.4774733
5.265753      0.4391473 0.4122400 0.4660546 0.3979962 0.4802985</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Notice that it is not straightforward to get the point forecasts out - we have to convert it to a data frame first.</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stl.forecasts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 10
 $ method   : chr "STL +  ARIMA(0,1,3)"
 $ model    :List of 18
  ..$ coef     : Named num [1:3] -0.326 -0.118 0.041
  .. ..- attr(*, "names")= chr [1:3] "ma1" "ma2" "ma3"
  ..$ sigma2   : num 3.87e-05
  ..$ var.coef : num [1:3, 1:3] 0.000661 -0.000198 -0.000116 -0.000198 0.00067 ...
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ : chr [1:3] "ma1" "ma2" "ma3"
  .. .. ..$ : chr [1:3] "ma1" "ma2" "ma3"
  ..$ mask     : logi [1:3] TRUE TRUE TRUE
  ..$ loglik   : num 5591
  ..$ aic      : num -11174
  ..$ arma     : int [1:7] 0 3 0 0 365 1 0
  ..$ residuals: Time-Series [1:1528] from 1 to 5.18: 3.66e-04 -7.76e-05 1.23e-03 4.86e-04 -2.20e-04 ...
  ..$ call     : language auto.arima(y = x, seasonal = FALSE, xreg = xreg, x = list(x = c(0.365520220303196,  0.36543793829309, 0.366717656| __truncated__ ...
  ..$ series   : chr "x"
  ..$ code     : int 0
  ..$ n.cond   : int 0
  ..$ nobs     : int 1527
  ..$ model    :List of 10
  .. ..$ phi  : num(0) 
  .. ..$ theta: num [1:3] -0.326 -0.118 0.041
  .. ..$ Delta: num 1
  .. ..$ Z    : num [1:5] 1 0 0 0 1
  .. ..$ a    : num [1:5] 4.80e-03 2.00e-03 -9.60e-04 9.87e-05 3.71e-01
  .. ..$ P    : num [1:5, 1:5] 0.00 0.00 0.00 0.00 1.86e-21 ...
  .. ..$ T    : num [1:5, 1:5] 0 0 0 0 1 1 0 0 0 0 ...
  .. ..$ V    : num [1:5, 1:5] 1 -0.326 -0.118 0.041 0 ...
  .. ..$ h    : num 0
  .. ..$ Pn   : num [1:5, 1:5] 1.00 -3.26e-01 -1.18e-01 4.10e-02 2.67e-22 ...
  ..$ bic      : num -11153
  ..$ aicc     : num -11174
  ..$ x        : Time-Series [1:1528] from 1 to 5.18: 0.366 0.365 0.367 0.367 0.366 ...
  ..$ fitted   : Time-Series [1:1528] from 1 to 5.18: 0.365 0.366 0.365 0.366 0.367 ...
  ..- attr(*, "class")= chr [1:3] "forecast_ARIMA" "ARIMA" "Arima"
 $ level    : num [1:2] 80 95
 $ mean     : Time-Series [1:30] from 5.19 to 5.27: 0.447 0.453 0.448 0.441 0.445 ...
 $ lower    : Time-Series [1:30, 1:2] from 5.19 to 5.27: 0.439 0.443 0.437 0.429 0.433 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : NULL
  .. ..$ : chr [1:2] "80%" "95%"
 $ upper    : Time-Series [1:30, 1:2] from 5.19 to 5.27: 0.455 0.463 0.458 0.452 0.458 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : NULL
  .. ..$ : chr [1:2] "80%" "95%"
 $ x        : Time-Series [1:1528] from 1 to 5.18: 0.328 0.328 0.329 0.329 0.328 ...
 $ series   : chr "ts.train"
 $ fitted   : Time-Series [1:1528] from 1 to 5.18: 0.328 0.328 0.327 0.328 0.328 ...
 $ residuals: Time-Series [1:1528] from 1 to 5.18: 3.66e-04 -7.76e-05 1.23e-03 4.86e-04 -2.20e-04 ...
 - attr(*, "class")= chr "forecast"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>stl.df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(stl.forecasts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s visualize the forecasts! For the basic models available in the forecast package, we can use the <code>plot()</code> function to see a quick time series plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's look at the forecasts!</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(stl.forecasts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s compare them to the observed test series values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First make a data frame with both in there</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">observed =</span> test<span class="sc">$</span>observation,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">forecast =</span> stl.df<span class="sc">$</span><span class="st">`</span><span class="at">Point Forecast</span><span class="st">`</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># What do you think??</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> compare, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> observed))<span class="sc">+</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> forecast), <span class="at">color =</span> <span class="st">"red"</span>)<span class="sc">+</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> forecast), <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can generate some accuracy metrics and save them in a data frame for later use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Last - let's get the RMSE and MAE out. We can use the Metrics package for this. While we're at it, let's save them to a data set for later.</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Metrics'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:forecast':

    accuracy</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>stl.rmse <span class="ot">&lt;-</span> <span class="fu">rmse</span>(compare<span class="sc">$</span>observed, compare<span class="sc">$</span>forecast)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>stl.mae <span class="ot">&lt;-</span> <span class="fu">mae</span>(compare<span class="sc">$</span>observed, compare<span class="sc">$</span>forecast)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>(comparisonDF <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">model =</span> <span class="st">"stl"</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">RMSE =</span> stl.rmse,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">MAE =</span> stl.mae))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  model       RMSE         MAE
1   stl 0.01162321 0.009048619</code></pre>
</div>
</div>
<p>An additional argument in <code>stlm()</code> exists that allows for the inclusion of extra predictors into an ARIMA-based model post-decomposition. This function requires the predictors to exist in a separate matrix rather than inside of a data frame, which makes it somewhat challenging to use if you are unfamiliar with using matrices in R.</p>
</section>
</section>
<section id="linear-regression" class="level2">
<h2 class="anchored" data-anchor-id="linear-regression">Linear Regression</h2>
<section id="slide-29-32" class="level4">
<h4 class="anchored" data-anchor-id="slide-29-32">Slide 29-32</h4>
<p>Fortunately, there are several kinds of time series models that accommodate extra predictors in a more intuitive way. The most obvious starting place is linear regression! We have a lot of predictors in our data set to choose from. Feel free to play around with them! For time’s sake, I am going to use mean temperature and its one day lag only. This part is probably not too different from what you are used to doing for non-time series data. The only major difference is in what predictors we choose to include to account for autocorrelation, trend, and seasonality.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We will start with just our predictors</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>lm.fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(observation <span class="sc">~</span> meanTemp <span class="sc">+</span> meanTempLag1, </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> train)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm.fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = observation ~ meanTemp + meanTempLag1, data = train)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.108835 -0.017111  0.001229  0.016760  0.090118 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.2626627  0.0022072 119.002   &lt;2e-16 ***
meanTemp     0.0011590  0.0001145  10.124   &lt;2e-16 ***
meanTempLag1 0.0011180  0.0001145   9.764   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.02741 on 1525 degrees of freedom
Multiple R-squared:  0.6546,    Adjusted R-squared:  0.6541 
F-statistic:  1445 on 2 and 1525 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(lm.fit<span class="sc">$</span>residuals, <span class="dv">365</span>) <span class="co"># Still a lot of seasonality left</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s add the sine and cosine terms we discussed into the data set to include them in the model. We will need to do this for <code>train</code> and <code>test</code>. Note that if you were to be forecasting beyond test, you would need to generate these terms for those time points as well.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add to the training set</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>train<span class="sc">$</span>sinSeason <span class="ot">&lt;-</span> <span class="fu">sin</span>((<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>train<span class="sc">$</span>X)<span class="sc">/</span><span class="dv">365</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>train<span class="sc">$</span>cosSeason <span class="ot">&lt;-</span> <span class="fu">cos</span>((<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>train<span class="sc">$</span>X)<span class="sc">/</span><span class="dv">365</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add to the testing set</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>sinSeason <span class="ot">&lt;-</span> <span class="fu">sin</span>((<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>test<span class="sc">$</span>X)<span class="sc">/</span><span class="dv">365</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>cosSeason <span class="ot">&lt;-</span> <span class="fu">cos</span>((<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>test<span class="sc">$</span>X)<span class="sc">/</span><span class="dv">365</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Back to business! Let’s add in the sine and cosine terms for seasonality.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add seasonality via sine and cosine terms</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>lm.fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(observation <span class="sc">~</span> sinSeason <span class="sc">+</span> cosSeason <span class="sc">+</span> meanTemp <span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>               meanTempLag1, </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> train)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm.fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = observation ~ sinSeason + cosSeason + meanTemp + 
    meanTempLag1, data = train)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.081050 -0.013551  0.003378  0.016710  0.072831 

Coefficients:
               Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   0.3531644  0.0049347  71.568   &lt;2e-16 ***
sinSeason     0.0447465  0.0022696  19.715   &lt;2e-16 ***
cosSeason    -0.0154489  0.0011013 -14.027   &lt;2e-16 ***
meanTemp      0.0002431  0.0001119   2.172   0.0300 *  
meanTempLag1  0.0001918  0.0001119   1.714   0.0868 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.0244 on 1523 degrees of freedom
Multiple R-squared:  0.7266,    Adjusted R-squared:  0.7259 
F-statistic:  1012 on 4 and 1523 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(lm.fit<span class="sc">$</span>residuals, <span class="dv">365</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can add in the trend.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add trend</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>lm.fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(observation <span class="sc">~</span> X <span class="sc">+</span> sinSeason <span class="sc">+</span> cosSeason <span class="sc">+</span> meanTemp <span class="sc">+</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>               meanTempLag1, </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> train)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm.fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = observation ~ X + sinSeason + cosSeason + meanTemp + 
    meanTempLag1, data = train)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.082566 -0.013092  0.003663  0.016387  0.063609 

Coefficients:
               Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   3.465e-01  4.895e-03  70.789  &lt; 2e-16 ***
X             1.164e-05  1.403e-06   8.297 2.33e-16 ***
sinSeason     4.662e-02  2.232e-03  20.884  &lt; 2e-16 ***
cosSeason    -1.637e-02  1.083e-03 -15.112  &lt; 2e-16 ***
meanTemp      2.202e-04  1.096e-04   2.010   0.0446 *  
meanTempLag1  1.694e-04  1.096e-04   1.546   0.1222    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.02388 on 1522 degrees of freedom
Multiple R-squared:  0.7384,    Adjusted R-squared:  0.7376 
F-statistic: 859.3 on 5 and 1522 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for leftover autocorrelation in the residuals - still a lot.</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   Stay tuned for how to deal with this! For now we will move forward.</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(lm.fit<span class="sc">$</span>residuals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># These models still do assume normal residuals - these look good!</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(lm.fit<span class="sc">$</span>residuals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-21-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Next we’ll generate forecasts for this model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can generate forecasts with the forecast() function in the forecast package</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>lm.forecasts <span class="ot">&lt;-</span> <span class="fu">forecast</span>(lm.fit, <span class="at">h =</span> <span class="dv">30</span>, <span class="at">newdata =</span> test)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The forecast function gives us point forecasts, as well as prediction intervals</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>lm.forecasts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Point Forecast     Lo 80     Hi 80     Lo 95     Hi 95
1       0.4265763 0.3958960 0.4572565 0.3796379 0.4735146
2       0.4286415 0.3979637 0.4593193 0.3817068 0.4755761
3       0.4298292 0.3991522 0.4605061 0.3828959 0.4767625
4       0.4295394 0.3988597 0.4602191 0.3826018 0.4764769
5       0.4285087 0.3978253 0.4591920 0.3815655 0.4754518
6       0.4300729 0.3993812 0.4607646 0.3831171 0.4770288
7       0.4337247 0.4030231 0.4644262 0.3867538 0.4806956
8       0.4348493 0.4041528 0.4655458 0.3878861 0.4818125
9       0.4350253 0.4043367 0.4657138 0.3880742 0.4819763
10      0.4348475 0.4041593 0.4655356 0.3878971 0.4817979
11      0.4333377 0.4026513 0.4640242 0.3863899 0.4802856
12      0.4336375 0.4029566 0.4643184 0.3866982 0.4805769
13      0.4348544 0.4041768 0.4655320 0.3879201 0.4817887
14      0.4359595 0.4052789 0.4666402 0.3890205 0.4828985
15      0.4376019 0.4069138 0.4682900 0.3906515 0.4845523
16      0.4370947 0.4064009 0.4677886 0.3901356 0.4840539
17      0.4350371 0.4043475 0.4657267 0.3880844 0.4819898
18      0.4350350 0.4043494 0.4657207 0.3880884 0.4819817
19      0.4377471 0.4070499 0.4684442 0.3907829 0.4847112
20      0.4379329 0.4072393 0.4686266 0.3909741 0.4848917
21      0.4371022 0.4064218 0.4677826 0.3901636 0.4840408
22      0.4379258 0.4072451 0.4686064 0.3909868 0.4848647
23      0.4389425 0.4082622 0.4696228 0.3920040 0.4858809
24      0.4403174 0.4096319 0.4710030 0.3933710 0.4872639
25      0.4414457 0.4107581 0.4721334 0.3944961 0.4883954
26      0.4413800 0.4106927 0.4720672 0.3944309 0.4883290
27      0.4412094 0.4105261 0.4718927 0.3942664 0.4881524
28      0.4416591 0.4109746 0.4723435 0.3947143 0.4886039
29      0.4422830 0.4115963 0.4729697 0.3953348 0.4892312
30      0.4427546 0.4120662 0.4734429 0.3958038 0.4897053</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Notice that it is not straightforward to get the point forecasts out - we have to convert it to a data frame first.</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(lm.forecasts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 11
 $ model    :List of 14
  ..$ coefficients : Named num [1:6] 3.46e-01 1.16e-05 4.66e-02 -1.64e-02 2.20e-04 ...
  .. ..- attr(*, "names")= chr [1:6] "(Intercept)" "X" "sinSeason" "cosSeason" ...
  ..$ residuals    : Named num [1:1528] -0.0201 -0.0215 -0.0227 -0.022 -0.0225 ...
  .. ..- attr(*, "names")= chr [1:1528] "1" "2" "3" "4" ...
  ..$ effects      : Named num [1:1528] -14.6653 -0.0223 1.471 0.525 0.0881 ...
  .. ..- attr(*, "names")= chr [1:1528] "(Intercept)" "X" "sinSeason" "cosSeason" ...
  ..$ rank         : int 6
  ..$ fitted.values: Named num [1:1528] 0.348 0.349 0.351 0.351 0.35 ...
  .. ..- attr(*, "names")= chr [1:1528] "1" "2" "3" "4" ...
  ..$ assign       : int [1:6] 0 1 2 3 4 5
  ..$ qr           :List of 5
  .. ..$ qr   : num [1:1528, 1:6] -39.0896 0.0256 0.0256 0.0256 0.0256 ...
  .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. ..$ : chr [1:1528] "1" "2" "3" "4" ...
  .. .. .. ..$ : chr [1:6] "(Intercept)" "X" "sinSeason" "cosSeason" ...
  .. .. ..- attr(*, "assign")= int [1:6] 0 1 2 3 4 5
  .. ..$ qraux: num [1:6] 1.03 1.04 1 1.04 1.01 ...
  .. ..$ pivot: int [1:6] 1 2 3 4 5 6
  .. ..$ tol  : num 1e-07
  .. ..$ rank : int 6
  .. ..- attr(*, "class")= chr "qr"
  ..$ df.residual  : int 1522
  ..$ xlevels      : Named list()
  ..$ call         : language lm(formula = observation ~ X + sinSeason + cosSeason + meanTemp + meanTempLag1,      data = train)
  ..$ terms        :Classes 'terms', 'formula'  language observation ~ X + sinSeason + cosSeason + meanTemp + meanTempLag1
  .. .. ..- attr(*, "variables")= language list(observation, X, sinSeason, cosSeason, meanTemp, meanTempLag1)
  .. .. ..- attr(*, "factors")= int [1:6, 1:5] 0 1 0 0 0 0 0 0 1 0 ...
  .. .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. .. ..$ : chr [1:6] "observation" "X" "sinSeason" "cosSeason" ...
  .. .. .. .. ..$ : chr [1:5] "X" "sinSeason" "cosSeason" "meanTemp" ...
  .. .. ..- attr(*, "term.labels")= chr [1:5] "X" "sinSeason" "cosSeason" "meanTemp" ...
  .. .. ..- attr(*, "order")= int [1:5] 1 1 1 1 1
  .. .. ..- attr(*, "intercept")= int 1
  .. .. ..- attr(*, "response")= int 1
  .. .. ..- attr(*, ".Environment")=&lt;environment: R_GlobalEnv&gt; 
  .. .. ..- attr(*, "predvars")= language list(observation, X, sinSeason, cosSeason, meanTemp, meanTempLag1)
  .. .. ..- attr(*, "dataClasses")= Named chr [1:6] "numeric" "numeric" "numeric" "numeric" ...
  .. .. .. ..- attr(*, "names")= chr [1:6] "observation" "X" "sinSeason" "cosSeason" ...
  ..$ model        :'data.frame':   1528 obs. of  6 variables:
  .. ..$ observation : num [1:1528] 0.328 0.328 0.329 0.329 0.328 ...
  .. ..$ X           : int [1:1528] 1 2 3 4 5 6 7 8 9 10 ...
  .. ..$ sinSeason   : num [1:1528] 0.0172 0.0344 0.0516 0.0688 0.086 ...
  .. ..$ cosSeason   : num [1:1528] 1 0.999 0.999 0.998 0.996 ...
  .. ..$ meanTemp    : num [1:1528] 41.1 48.5 47.6 42.4 40.5 ...
  .. ..$ meanTempLag1: num [1:1528] 47.9 41.1 48.5 47.6 42.4 ...
  .. ..- attr(*, "terms")=Classes 'terms', 'formula'  language observation ~ X + sinSeason + cosSeason + meanTemp + meanTempLag1
  .. .. .. ..- attr(*, "variables")= language list(observation, X, sinSeason, cosSeason, meanTemp, meanTempLag1)
  .. .. .. ..- attr(*, "factors")= int [1:6, 1:5] 0 1 0 0 0 0 0 0 1 0 ...
  .. .. .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. .. .. ..$ : chr [1:6] "observation" "X" "sinSeason" "cosSeason" ...
  .. .. .. .. .. ..$ : chr [1:5] "X" "sinSeason" "cosSeason" "meanTemp" ...
  .. .. .. ..- attr(*, "term.labels")= chr [1:5] "X" "sinSeason" "cosSeason" "meanTemp" ...
  .. .. .. ..- attr(*, "order")= int [1:5] 1 1 1 1 1
  .. .. .. ..- attr(*, "intercept")= int 1
  .. .. .. ..- attr(*, "response")= int 1
  .. .. .. ..- attr(*, ".Environment")=&lt;environment: R_GlobalEnv&gt; 
  .. .. .. ..- attr(*, "predvars")= language list(observation, X, sinSeason, cosSeason, meanTemp, meanTempLag1)
  .. .. .. ..- attr(*, "dataClasses")= Named chr [1:6] "numeric" "numeric" "numeric" "numeric" ...
  .. .. .. .. ..- attr(*, "names")= chr [1:6] "observation" "X" "sinSeason" "cosSeason" ...
  ..$ x            : num [1:1528] 0.328 0.328 0.329 0.329 0.328 ...
  ..$ series       : chr "observation"
  ..- attr(*, "class")= chr "lm"
 $ mean     : Named num [1:30] 0.427 0.429 0.43 0.43 0.429 ...
  ..- attr(*, "names")= chr [1:30] "1529" "1530" "1531" "1532" ...
 $ lower    : num [1:30, 1:2] 0.396 0.398 0.399 0.399 0.398 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : chr [1:30] "1529" "1530" "1531" "1532" ...
  .. ..$ : NULL
 $ upper    : num [1:30, 1:2] 0.457 0.459 0.461 0.46 0.459 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : chr [1:30] "1529" "1530" "1531" "1532" ...
  .. ..$ : NULL
 $ level    : num [1:2] 80 95
 $ x        : num [1:1528] 0.328 0.328 0.329 0.329 0.328 ...
 $ series   : chr "observation"
 $ method   : chr "Linear regression model"
 $ newdata  :'data.frame':  30 obs. of  30 variables:
  ..$ X.1                   : int [1:30] 1529 1530 1531 1532 1533 1534 1535 1536 1537 1538 ...
  ..$ DATE                  : chr [1:30] "2024-06-12" "2024-06-13" "2024-06-14" "2024-06-15" ...
  ..$ X                     : int [1:30] 1529 1530 1531 1532 1533 1534 1535 1536 1537 1538 ...
  ..$ project_id            : chr [1:30] "neon4cast" "neon4cast" "neon4cast" "neon4cast" ...
  ..$ site_id               : chr [1:30] "HARV" "HARV" "HARV" "HARV" ...
  ..$ datetime              : chr [1:30] "2024-06-12" "2024-06-13" "2024-06-14" "2024-06-15" ...
  ..$ duration              : chr [1:30] "P1D" "P1D" "P1D" "P1D" ...
  ..$ variable              : chr [1:30] "gcc_90" "gcc_90" "gcc_90" "gcc_90" ...
  ..$ observation           : num [1:30] 0.445 0.429 0.453 0.429 0.434 ...
  ..$ update                : num [1:30] 0.445 0.429 0.453 0.429 0.434 ...
  ..$ meanTemp              : num [1:30] 66.5 70 70.1 66.2 62.1 ...
  ..$ minTemp               : int [1:30] 54 50 65 51 45 55 61 68 67 66 ...
  ..$ maxTemp               : int [1:30] 77 84 77 75 73 81 91 92 91 90 ...
  ..$ meanRH                : num [1:30] 68.5 59.7 82.3 56.5 58 ...
  ..$ minRH                 : int [1:30] 40 35 73 29 26 51 45 52 54 48 ...
  ..$ maxRH                 : int [1:30] 100 93 97 93 93 90 93 100 100 100 ...
  ..$ totalPrecipitation    : num [1:30] 0 0 0.2 0 0 0 0 0.97 1.72 2.63 ...
  ..$ meanWindSpeed         : num [1:30] 3.96 6.04 6.27 8.83 3.33 ...
  ..$ maxWindSpeed          : int [1:30] 10 14 16 18 9 14 15 31 21 9 ...
  ..$ meanTempLag1          : num [1:30] 62.2 66.5 70 70.1 66.2 ...
  ..$ minTempLag1           : int [1:30] 50 54 50 65 51 45 55 61 68 67 ...
  ..$ maxTempLag1           : int [1:30] 70 77 84 77 75 73 81 91 92 91 ...
  ..$ meanRHLag1            : num [1:30] 80.2 68.5 59.7 82.3 56.5 ...
  ..$ minRHLag1             : int [1:30] 57 40 35 73 29 26 51 45 52 54 ...
  ..$ maxRHLag1             : int [1:30] 100 100 93 97 93 93 90 93 100 100 ...
  ..$ totalPrecipitationLag1: num [1:30] 0 0 0 0.2 0 0 0 0 0.97 1.72 ...
  ..$ meanWindSpeedLag1     : num [1:30] 2.79 3.96 6.04 6.27 8.83 ...
  ..$ maxWindSpeedLag1      : int [1:30] 8 10 14 16 18 9 14 15 31 21 ...
  ..$ sinSeason             : num [1:30] 0.928 0.934 0.94 0.946 0.951 ...
  ..$ cosSeason             : num [1:30] 0.374 0.358 0.342 0.325 0.309 ...
 $ residuals: Named num [1:1528] -0.0201 -0.0215 -0.0227 -0.022 -0.0225 ...
  ..- attr(*, "names")= chr [1:1528] "1" "2" "3" "4" ...
 $ fitted   : Named num [1:1528] 0.348 0.349 0.351 0.351 0.35 ...
  ..- attr(*, "names")= chr [1:1528] "1" "2" "3" "4" ...
 - attr(*, "class")= chr "forecast"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>lm.df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(lm.forecasts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can visualize the forecasts against the observed values if we add them to our <code>test</code> data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the forecasts to test</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>forecast <span class="ot">&lt;-</span> lm.df<span class="sc">$</span><span class="st">`</span><span class="at">Point Forecast</span><span class="st">`</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's look at the forecasts!</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co"># What do you test??</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> compare, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> observed))<span class="sc">+</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> forecast), <span class="at">color =</span> <span class="st">"red"</span>)<span class="sc">+</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> forecast), <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally we will generate and save the accuracy metrics again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Last - let's get the RMSE and MAE out. We can use the Metrics package for this. While we're at it, let's save them to a data set for later.</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>lm.rmse <span class="ot">&lt;-</span> <span class="fu">rmse</span>(test<span class="sc">$</span>observation, test<span class="sc">$</span>forecast)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>lm.mae <span class="ot">&lt;-</span> <span class="fu">mae</span>(test<span class="sc">$</span>observation, test<span class="sc">$</span>forecast)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>newrow <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"lm"</span>, lm.rmse, lm.mae)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>(comparisonDF <span class="ot">&lt;-</span> <span class="fu">rbind</span>(comparisonDF, newrow))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  model               RMSE                 MAE
1   stl 0.0116232134034641 0.00904861924106978
2    lm 0.0113361721973712 0.00885045372950685</code></pre>
</div>
</div>
</section>
<section id="applying-arima-to-the-residual-series-arima-as-a-second-layer-model" class="level3">
<h3 class="anchored" data-anchor-id="applying-arima-to-the-residual-series-arima-as-a-second-layer-model">Applying ARIMA to the residual series (ARIMA as a second-layer model)</h3>
<section id="slide-34-39" class="level4">
<h4 class="anchored" data-anchor-id="slide-34-39">Slide 34-39</h4>
<p>We can adjust any model with correlated error terms by modeling its residuals! The process is as follows:</p>
<ol type="1">
<li>Build a model</li>
<li>Extract the residual series</li>
<li>Model the residuals using ARIMA (or another time series model of your choosing)</li>
<li>Forecast the future residuals</li>
<li>Adjust your forecasts using your forecasted residuals.</li>
</ol>
<p>We are going to use the linear model from above as an example to see what effect it has on our predictions. First, let’s extract the residuals and turn them into a time series object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a time series of the residuals from the model</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>lmResids <span class="ot">&lt;-</span> <span class="fu">ts</span>(lm.fit<span class="sc">$</span>residuals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can use the <code>auto.arima()</code> function to fit an ARIMA model to the residual series. Remember, <code>auto.arima()</code> will select p, d, and q for us.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the auto.arima() function to easily fit an ARIMA model</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>resid.fit <span class="ot">&lt;-</span> <span class="fu">auto.arima</span>(lmResids)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(resid.fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: lmResids 
ARIMA(3,0,4) with zero mean 

Coefficients:
         ar1     ar2      ar3      ma1      ma2     ma3     ma4
      0.9117  0.9255  -0.8546  -0.1998  -0.9377  0.3255  0.0977
s.e.  0.0420  0.0259   0.0372   0.0485   0.0356  0.0258  0.0299

sigma^2 = 4.973e-05:  log likelihood = 5404.25
AIC=-10792.5   AICc=-10792.41   BIC=-10749.85

Training set error measures:
                       ME        RMSE         MAE      MPE     MAPE      MASE
Training set 1.177324e-05 0.007036099 0.004752026 30.56487 84.39989 0.9678809
                      ACF1
Training set -0.0006014338</code></pre>
</div>
</div>
<p>Now we will make forecasts for the error for the next 30 days and use those forecasted errors to adjust our original forecasts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast the error</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>resid.forecast <span class="ot">&lt;-</span> <span class="fu">forecast</span>(resid.fit, <span class="at">h =</span> <span class="dv">30</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>resid.df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(resid.forecast)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust the original forecasts using the forecasted residuals</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>adjForecast <span class="ot">&lt;-</span> test<span class="sc">$</span>forecast <span class="sc">+</span> resid.df<span class="sc">$</span><span class="st">`</span><span class="at">Point Forecast</span><span class="st">`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see what effect that had on our original forecasts - any better?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Some data cleaning...</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>testLong <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(forecast, observation, adjForecast), <span class="at">names_to =</span> <span class="st">"forecastType"</span>, <span class="at">values_to =</span> <span class="st">"prediction"</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the results! What do you think?</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> testLong, <span class="fu">aes</span>(<span class="at">x =</span> X, <span class="at">y =</span> prediction))<span class="sc">+</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> forecastType, <span class="at">lty =</span> forecastType))<span class="sc">+</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> forecastType))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can look at the <code>acf()</code> plots from before and after to see how they compare.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Did we take care of that extra autocorrelation from before?</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>oldResids <span class="ot">&lt;-</span> test<span class="sc">$</span>observation <span class="sc">-</span> test<span class="sc">$</span>forecast</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(test<span class="sc">$</span>oldResids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>newResids <span class="ot">&lt;-</span> test<span class="sc">$</span>observation <span class="sc">-</span> test<span class="sc">$</span>adjForecast</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(test<span class="sc">$</span>newResids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-29-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, let’s generate a new set of accuracy metrics for the adjusted model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We will add this to our comparisonDF to compare later</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>lmAdj.rmse <span class="ot">&lt;-</span> <span class="fu">rmse</span>(test<span class="sc">$</span>observation, test<span class="sc">$</span>adjForecast)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>lmAdj.mae <span class="ot">&lt;-</span> <span class="fu">mae</span>(test<span class="sc">$</span>observation, test<span class="sc">$</span>adjForecast)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>newrow <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"lmAdj"</span>, lmAdj.rmse, lmAdj.mae)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>(comparisonDF <span class="ot">&lt;-</span> <span class="fu">rbind</span>(comparisonDF, newrow))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  model                RMSE                 MAE
1   stl  0.0116232134034641 0.00904861924106978
2    lm  0.0113361721973712 0.00885045372950685
3 lmAdj 0.00975236059762854 0.00759983144121353</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="generalized-additive-models-gams" class="level2">
<h2 class="anchored" data-anchor-id="generalized-additive-models-gams">(Generalized) Additive Models (GAMs)</h2>
<section id="not-in-lecture-bonus" class="level4">
<h4 class="anchored" data-anchor-id="not-in-lecture-bonus">Not in lecture :) #Bonus</h4>
<p>We did not explicitly cover these in the lecture, but Generalized Additive Models (GAMs) are similar to generalized linear models except that they allow us to include spline terms. These can be useful tools for seasonal data as well. On the flip side, splines are complicated beasts and highly susceptible to traps like overfitting. We don’t have time to cover them in depth today so I set a few things in the <code>s()</code> function for you, but I highly encourage you to look at the documentation for both the <code>gam()</code> model fitting function in <code>mgcv</code> and the <code>s()</code> function that produces the spline terms.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># GAM modeling</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'nlme'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:forecast':

    getResponse</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    collapse</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We need a 'day of the year' variable to capture the annual seasonality.</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>train<span class="sc">$</span>DOY <span class="ot">&lt;-</span> <span class="fu">yday</span>(train<span class="sc">$</span>DATE)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>DOY <span class="ot">&lt;-</span> <span class="fu">yday</span>(test<span class="sc">$</span>DATE)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>gam.fit <span class="ot">&lt;-</span> <span class="fu">gam</span>(observation <span class="sc">~</span> X <span class="sc">+</span> meanTemp <span class="sc">+</span> meanTempLag1 <span class="sc">+</span> </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">s</span>(DOY, <span class="at">bs =</span> <span class="st">"cr"</span>, <span class="at">k =</span> <span class="dv">2</span>),</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in smooth.construct.cr.smooth.spec(object, dk$data, dk$knots): basis dimension, k, increased to minimum possible</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gam.fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
observation ~ X + meanTemp + meanTempLag1 + s(DOY, bs = "cr", 
    k = 2)

Parametric coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  2.775e-01  4.485e-03  61.860  &lt; 2e-16 ***
X            8.699e-06  1.565e-06   5.560 3.19e-08 ***
meanTemp     9.191e-04  1.187e-04   7.743 1.76e-14 ***
meanTempLag1 9.240e-04  1.173e-04   7.878 6.26e-15 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
         edf Ref.df     F p-value    
s(DOY) 1.971  1.999 24.67  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.671   Deviance explained = 67.2%
GCV = 0.00071784  Scale est. = 0.00071503  n = 1528</code></pre>
</div>
</div>
<p>Most of the techniques from the linear model above apply here. We can evaluate the residuals to see if we missed any opportunities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for leftover autocorrelation in the residuals - it may be wise to apply the residual ARIMA from above.</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(gam.fit<span class="sc">$</span>residuals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># These models still do assume normal residuals - these look good!</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(gam.fit<span class="sc">$</span>residuals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-32-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This time we will generate forecasts using the <code>predict()</code> function because it works better with this kind of model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For some reason the forecast() function did not like the GAM... We can just use good old predict to do the same thing since test contains the number of rows we need.</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>gam.forecasts <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam.fit, <span class="at">newdata =</span> test)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The predict function gives us point forecasts.</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>gam.forecasts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     1529      1530      1531      1532      1533      1534      1535      1536 
0.4194578 0.4266983 0.4301488 0.4267564 0.4194278 0.4229415 0.4378083 0.4422476 
     1537      1538      1539      1540      1541      1542      1543      1544 
0.4402423 0.4378353 0.4287927 0.4269180 0.4310494 0.4340437 0.4397890 0.4368044 
     1545      1546      1547      1548      1549      1550      1551      1552 
0.4251501 0.4223446 0.4327906 0.4339941 0.4275738 0.4297662 0.4331898 0.4380823 
     1553      1554      1555      1556      1557      1558 
0.4424296 0.4412897 0.4390363 0.4399015 0.4418108 0.4431266 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the forecasts to test</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>GAMforecast <span class="ot">&lt;-</span> gam.forecasts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see what they look like and stash the accuracy metrics for later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's look at the forecasts!</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co"># What do you think??</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> test, <span class="fu">aes</span>(<span class="at">x =</span> X, <span class="at">y =</span> observation))<span class="sc">+</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> GAMforecast), <span class="at">color =</span> <span class="st">"red"</span>)<span class="sc">+</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> GAMforecast), <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the results</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>gam.rmse <span class="ot">&lt;-</span> <span class="fu">rmse</span>(test<span class="sc">$</span>observation, test<span class="sc">$</span>GAMforecast)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>gam.mae <span class="ot">&lt;-</span> <span class="fu">mae</span>(test<span class="sc">$</span>observation, test<span class="sc">$</span>GAMforecast)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>newrow <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"gam"</span>, gam.rmse, gam.mae)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>(comparisonDF <span class="ot">&lt;-</span> <span class="fu">rbind</span>(comparisonDF, newrow))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  model                RMSE                 MAE
1   stl  0.0116232134034641 0.00904861924106978
2    lm  0.0113361721973712 0.00885045372950685
3 lmAdj 0.00975236059762854 0.00759983144121353
4   gam   0.012275278533877 0.00938259655210016</code></pre>
</div>
</div>
</section>
</section>
<section id="time-varying-coefficient-ar-model" class="level2">
<h2 class="anchored" data-anchor-id="time-varying-coefficient-ar-model">Time-Varying Coefficient AR Model</h2>
<section id="slide-50-51" class="level4">
<h4 class="anchored" data-anchor-id="slide-50-51">Slide 50-51</h4>
<p>Time-varying (TV) coefficient models gained popularity after their introduction to the forecasting world and their applications and methodologies are now expansive. There is no way to cover all of the TV models that are now available in software, so we will explore a time-varying auto-regressive (TVAR) model in the <code>tvReg</code> package in R. This package supports several other kinds of TV models as well.</p>
<p><code>tvReg</code> requires that we clean up our data some to only include the necessary information. We will do that first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tvReg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Matrix'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:tidyr':

    expand, pack, unpack</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Funded by the Horizon 2020. Framework Programme of the European Union.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'tvReg'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:forecast':

    forecast</code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>trainRed <span class="ot">&lt;-</span> train <span class="sc">%&gt;%</span> <span class="fu">select</span>(meanTemp,</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>                             meanTempLag1,</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>                             sinSeason,</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>                             cosSeason)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>testRed <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span> <span class="fu">select</span>(meanTemp,</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>                           meanTempLag1,</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>                           sinSeason,</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>                           cosSeason)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can fit the model! We are fitting a TV model that accounts for autocorrelation via an AR model. The argument <code>p</code> lets us tell <code>tvAR</code> how many lags to include in the AR part of the model. The <code>exogen</code> argument is where we put our data set of predictor variables that we made above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model - p represents the order of the AR model. </span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     Exogen contains the exogenous variables we want to use.</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     See the documentation for explanations of the other </span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     available options.</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>tvar.fit <span class="ot">&lt;-</span> <span class="fu">tvAR</span>(train<span class="sc">$</span>observation, <span class="at">p =</span> <span class="dv">1</span>, <span class="at">exogen =</span> trainRed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculating regression bandwidth...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tvar.fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: 
tvAR(y = train$observation, p = 1, exogen = trainRed)

Class:  tvar 

Summary of time-varying estimated coefficients: 
================================================ 
        (Intercept)   y.l1  meanTemp meanTempLag1 sinSeason cosSeason
Min.        0.01343 0.9525 0.0002315   -0.0001426  0.001012 0.0005829
1st Qu.     0.01344 0.9525 0.0002315   -0.0001426  0.001012 0.0005830
Median      0.01344 0.9525 0.0002315   -0.0001426  0.001012 0.0005831
Mean        0.01344 0.9525 0.0002315   -0.0001426  0.001012 0.0005831
3rd Qu.     0.01344 0.9526 0.0002315   -0.0001426  0.001013 0.0005832
Max.        0.01345 0.9526 0.0002315   -0.0001426  0.001013 0.0005833

Bandwidth:  20
Pseudo R-squared:  0.9751 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(tvar.fit<span class="sc">$</span>residuals, <span class="dv">365</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A neat thing to look at for the TV models is how the coefficients change with time. This is set within the modeling framework, so it is no surprise that these graphs look this way - hopefully these help you see how the model is allowing the betas to change.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot how the coefficients change over time</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>), <span class="at">bty=</span><span class="st">"n"</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(train<span class="sc">$</span>X[<span class="dv">2</span><span class="sc">:</span><span class="dv">1528</span>], tvar.fit<span class="sc">$</span>coefficients[,<span class="dv">1</span>]) <span class="co"># Intercept</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(train<span class="sc">$</span>X[<span class="dv">2</span><span class="sc">:</span><span class="dv">1528</span>], tvar.fit<span class="sc">$</span>coefficients[,<span class="dv">2</span>]) <span class="co"># coef for AR1</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(train<span class="sc">$</span>X[<span class="dv">2</span><span class="sc">:</span><span class="dv">1528</span>], tvar.fit<span class="sc">$</span>coefficients[,<span class="dv">3</span>]) <span class="co"># coef meanTemp</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(train<span class="sc">$</span>X[<span class="dv">2</span><span class="sc">:</span><span class="dv">1528</span>], tvar.fit<span class="sc">$</span>coefficients[,<span class="dv">4</span>]) <span class="co"># coef for meanTempLag1</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(train<span class="sc">$</span>X[<span class="dv">2</span><span class="sc">:</span><span class="dv">1528</span>], tvar.fit<span class="sc">$</span>coefficients[,<span class="dv">5</span>]) <span class="co"># coef for sin</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(train<span class="sc">$</span>X[<span class="dv">2</span><span class="sc">:</span><span class="dv">1528</span>], tvar.fit<span class="sc">$</span>coefficients[,<span class="dv">6</span>]) <span class="co"># coef for cos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Forecast generation time! The forecast function works for this package too! How do they look?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate 30 day out forecasts using the forecast function</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>tvarForecast <span class="ot">&lt;-</span> <span class="fu">forecast</span>(tvar.fit, <span class="at">n.ahead =</span> <span class="dv">30</span>, </span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">newexogen =</span> testRed)</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="co"># What do you think?</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> test, <span class="fu">aes</span>(<span class="at">x =</span> X, <span class="at">y =</span> observation))<span class="sc">+</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"black"</span>)<span class="sc">+</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"black"</span>)<span class="sc">+</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tvarForecast), <span class="at">color =</span> <span class="st">"red"</span>)<span class="sc">+</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> tvarForecast), <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We’ll save the results for later comparison.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the results</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>tvar.rmse <span class="ot">&lt;-</span> <span class="fu">rmse</span>(test<span class="sc">$</span>observation, test<span class="sc">$</span>tvarForecast)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>tvar.mae <span class="ot">&lt;-</span> <span class="fu">mae</span>(test<span class="sc">$</span>observation, test<span class="sc">$</span>tvarForecast)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>newrow <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tvar"</span>, tvar.rmse, tvar.mae)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>(comparisonDF <span class="ot">&lt;-</span> <span class="fu">rbind</span>(comparisonDF, newrow))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  model                RMSE                 MAE
1   stl  0.0116232134034641 0.00904861924106978
2    lm  0.0113361721973712 0.00885045372950685
3 lmAdj 0.00975236059762854 0.00759983144121353
4   gam   0.012275278533877 0.00938259655210016
5  tvar    0.01080312146469 0.00828432083262372</code></pre>
</div>
</div>
</section>
</section>
<section id="neural-network" class="level2">
<h2 class="anchored" data-anchor-id="neural-network">Neural Network</h2>
<section id="slide-53-55" class="level4">
<h4 class="anchored" data-anchor-id="slide-53-55">Slide 53-55</h4>
<p><em>Disclaimer: I do not claim to be an expert of any kind in machine learning methods, but I wanted to provide you with a basic ML option to explore. Additionally, if ML is what you find yourself interested in, I highly suggest you learn how to code in Python because it has way more tools for this kind of modeling :).</em></p>
<p>We need a particular predictor set up to model time series data and capture autocorrelation and seasonality. We can build this kind of model using the <code>nnetar()</code> function in the <code>forecast</code> package in R. This is nice because that means we can use all of the other useful functions in the <code>forecast</code> package too! It is also nice because it does all of the tedious pre-processing for us!</p>
<p>First we need to set up a data frame with relevant predictors like we did for the TV model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make reduced data set of predictors - this is how we have to set up the predictors for the model fitting package.</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>trainRed <span class="ot">&lt;-</span> train <span class="sc">%&gt;%</span> <span class="fu">select</span>(meanTemp,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>                             meanTempLag1)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>testRed <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span> <span class="fu">select</span>(meanTemp,</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>                           meanTempLag1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can fit the model! Notice we are building a time series object again and specifying a frequency. This tells <code>nnetar()</code> that the data are seasonal annually. We get to tell the model how far back to look using the <code>p</code> and <code>P</code> arguments. The argument <code>scale_inputs = T</code> does some critical centering and scaling for us to save us a lot of coding time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we are ready to fit the model!</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>obsTrain <span class="ot">&lt;-</span> <span class="fu">ts</span>(train<span class="sc">$</span>observation, <span class="at">frequency =</span> <span class="dv">365</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>nn.fit <span class="ot">&lt;-</span> <span class="fu">nnetar</span>(obsTrain,</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">xreg =</span> trainRed, <span class="co">#include our external predictors</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">scale.inputs =</span> T, <span class="co"># scale the inputs - critical for ML. The only time this would be set to F is if you already scaled them.</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">size =</span> <span class="dv">1</span>, <span class="co"># size of the hidden layer</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">p =</span> <span class="dv">2</span>, <span class="co"># number of regular lags</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">P =</span> <span class="dv">2</span>) <span class="co"># number of seasonal lags</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Time to make some forecasts!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To get the forecasts, we can use the forecast function. I had to explicitly tell R to look in the forecast package for this one. You may not need the extra forecast:: part.</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>nn.results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(forecast<span class="sc">::</span><span class="fu">forecast</span>(nn.fit, <span class="dv">30</span>, <span class="at">xreg =</span> testRed))</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>,</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">actual =</span> test<span class="sc">$</span>observation, </span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">forecast =</span> nn.results<span class="sc">$</span><span class="st">`</span><span class="at">Point Forecast</span><span class="st">`</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s have a look at the forecasts and save some accuracy metrics!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's check out the results!</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> results, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> actual))<span class="sc">+</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> forecast), <span class="at">color =</span> <span class="st">"red"</span>)<span class="sc">+</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> forecast), <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the results for comparison</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>nn.rmse <span class="ot">&lt;-</span> <span class="fu">rmse</span>(results<span class="sc">$</span>actual, results<span class="sc">$</span>forecast)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>nn.mae <span class="ot">&lt;-</span> <span class="fu">mae</span>(results<span class="sc">$</span>actual, results<span class="sc">$</span>forecast)</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>newrow <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"nn"</span>, nn.rmse, nn.mae)</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>(comparisonDF <span class="ot">&lt;-</span> <span class="fu">rbind</span>(comparisonDF, newrow))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  model                RMSE                 MAE
1   stl  0.0116232134034641 0.00904861924106978
2    lm  0.0113361721973712 0.00885045372950685
3 lmAdj 0.00975236059762854 0.00759983144121353
4   gam   0.012275278533877 0.00938259655210016
5  tvar    0.01080312146469 0.00828432083262372
6    nn 0.00957754199104779 0.00777989960957334</code></pre>
</div>
</div>
</section>
</section>
<section id="an-easy-ensemble" class="level2">
<h2 class="anchored" data-anchor-id="an-easy-ensemble">An Easy Ensemble</h2>
<section id="slide-57-58" class="level4">
<h4 class="anchored" data-anchor-id="slide-57-58">Slide 57-58</h4>
<p>The last modeling approach we will explore today is a basic ensemble modeling approach. Ensemble models incorporate forecasts from multiple other models to produce forecasts that are some kind of average of all the others. There are several averaging methods that exist, but a really simple one is to use a weighted average where the weight is based on each model’s test set RMSE. This way, the best performing models get to contribute the most information to the new forecasts. Amazingly, these ensembles often produce better predictions than any one model alone - even with bad predictions included!</p>
<p>First we will pull all of the forecasts we made into a data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a data set of all of the previous forecasts</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>ensembleDF <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">stl =</span> stl.df<span class="sc">$</span><span class="st">`</span><span class="at">Point Forecast</span><span class="st">`</span>,</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">lm =</span> lm.df<span class="sc">$</span><span class="st">`</span><span class="at">Point Forecast</span><span class="st">`</span>,</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">lmAdj =</span> test<span class="sc">$</span>adjForecast,</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">gam =</span> test<span class="sc">$</span>GAMforecast,</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">tvar =</span> test<span class="sc">$</span>tvarForecast,</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">nn =</span>  results<span class="sc">$</span>forecast,</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">observed =</span> test<span class="sc">$</span>observation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we need to build a weighting system for the ensemble predictions. Here we are going to use the system shown in the lecture (slide 58).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we can set up our weighting system based on RMSE</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>totalWeight <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>stl.rmse) <span class="sc">+</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>               (<span class="dv">1</span><span class="sc">/</span>lm.rmse) <span class="sc">+</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>               (<span class="dv">1</span><span class="sc">/</span>lmAdj.rmse) <span class="sc">+</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>               (<span class="dv">1</span><span class="sc">/</span>gam.rmse) <span class="sc">+</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>               (<span class="dv">1</span><span class="sc">/</span>tvar.rmse) <span class="sc">+</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>               (<span class="dv">1</span><span class="sc">/</span>nn.rmse)</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>weightSTL <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>stl.rmse)<span class="sc">/</span>totalWeight</span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>weightLM <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>lm.rmse)<span class="sc">/</span>totalWeight</span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>weightLMadj <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>lmAdj.rmse)<span class="sc">/</span>totalWeight</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>weightGAM <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>gam.rmse)<span class="sc">/</span>totalWeight</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>weightTVAR <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>tvar.rmse)<span class="sc">/</span>totalWeight</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>weightNN <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>nn.rmse)<span class="sc">/</span>totalWeight</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can use those weights to build a column of ensemble forecasts into the data set we made. All we have to do is multiply the other forecasts by their weights and add them all up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a column to our data frame with the ensemble forecasts</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>ensembleDF <span class="ot">&lt;-</span> ensembleDF <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ensembleForecast =</span> </span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>                                      (stl<span class="sc">*</span>weightSTL)<span class="sc">+</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>                                      (lm<span class="sc">*</span>weightLM)<span class="sc">+</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>                                      (lmAdj<span class="sc">*</span>weightLMadj)<span class="sc">+</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>                                      (gam<span class="sc">*</span>weightGAM)<span class="sc">+</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>                                      (tvar<span class="sc">*</span>weightTVAR)<span class="sc">+</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>                                      (nn<span class="sc">*</span>weightNN))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see how the ensemble predictions look!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's check them out!</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>ensembleDF<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="co"># What do you think??</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ensembleDF, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> observed))<span class="sc">+</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ensembleForecast), <span class="at">color =</span> <span class="st">"red"</span>)<span class="sc">+</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> ensembleForecast), <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Last we will save the accuracy metrics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the results like before</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>ens.rmse <span class="ot">&lt;-</span> <span class="fu">rmse</span>(ensembleDF<span class="sc">$</span>observed, ensembleDF<span class="sc">$</span>ensembleForecast)</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>ens.mae <span class="ot">&lt;-</span> <span class="fu">mae</span>(ensembleDF<span class="sc">$</span>observed, ensembleDF<span class="sc">$</span>ensembleForecast)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>newrow <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ens"</span>, ens.rmse, ens.mae)</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>(comparisonDF <span class="ot">&lt;-</span> <span class="fu">rbind</span>(comparisonDF, newrow))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  model                RMSE                 MAE
1   stl  0.0116232134034641 0.00904861924106978
2    lm  0.0113361721973712 0.00885045372950685
3 lmAdj 0.00975236059762854 0.00759983144121353
4   gam   0.012275278533877 0.00938259655210016
5  tvar    0.01080312146469 0.00828432083262372
6    nn 0.00957754199104779 0.00777989960957334
7   ens 0.00944071281885272 0.00786566824479918</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="evaluate-and-compare-performance" class="level1">
<h1>Evaluate and Compare Performance</h1>
<section id="slide-10-12" class="level4">
<h4 class="anchored" data-anchor-id="slide-10-12">Slide 10-12</h4>
<p>We have been saving performance metrics for all of our models so far - let’s check them out with a graph! Remember - for RMSE and MAE, lower is better. Feel free to take the inverse and look at that if it is confusing to consider this visually.<br>
</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>comparisonDF<span class="sc">$</span>RMSE <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(comparisonDF<span class="sc">$</span>RMSE)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>comparisonDF<span class="sc">$</span>MAE <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(comparisonDF<span class="sc">$</span>MAE)</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Which model did the best based on RMSE?</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> comparisonDF, <span class="fu">aes</span>(<span class="at">x =</span> model, <span class="at">y =</span> RMSE))<span class="sc">+</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"slateblue1"</span>)<span class="sc">+</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"RMSE Comparison"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Which model did the best based on MAE?</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> comparisonDF, <span class="fu">aes</span>(<span class="at">x =</span> model, <span class="at">y =</span> MAE))<span class="sc">+</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"plum"</span>)<span class="sc">+</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"MAE Comparison"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="VB_TimeSeriesForecastingPractical_files/figure-html/unnamed-chunk-49-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You probably notice that the best model is a little bit different depending on the metric you use. I would consider what we just did to be an exploratory modeling exercise. We went through a high volume of candidate models with very little fine tuning to see what worked. If we were to want to forecast tree greenness for real, we could take all three of the best overall performing models and try to fine tune them more to get even better results.</p>
</section>
<section id="next-steps" class="level3">
<h3 class="anchored" data-anchor-id="next-steps">Next Steps</h3>
<p>To generate the real forecasts, we would re-fit the best model using <em>all</em> of the data we have. Using the new model parameters, we would then make forecasts out to the desired horizon (in this case 30 days out).</p>
<p>If your chosen model is the ensemble, you would re-fit <em>all</em> of the models with <em>all</em> of the data and then multiply the forecasts you make by the weights you already generated.</p>
</section>
</section>
<section id="your-turn" class="level1">
<h1>Your Turn!</h1>
<p>NOW IT IS TIME FOR THE FORECASTING CHALLENGE OF A LIFETIME (or at least of the workshop). You (and your team??) are going to use another NEON data set that contains information about beetle abundances to generate the best forecasts you can for 5 observation periods past the end of the data set that is provided to you. You will submit your 5 forecasts and some details about your final model to a Google form and they will be judged on accuracy and perhaps creativity if necessary. The winning person (team?) will receive a fabulous prize that you do NOT want to miss!</p>
<p>The catch?? You only have 1 hour…. GO!</p>
<section id="challenge-details" class="level2">
<h2 class="anchored" data-anchor-id="challenge-details">Challenge Details</h2>
<section id="the-data-set" class="level3">
<h3 class="anchored" data-anchor-id="the-data-set">The Data Set</h3>
<p>You will use the data set called NEONbeetlesChallenge.csv for this challenge. It contains biweekly (every two weeks) observations of beetle abundances at one NEON site, in addition to several climatological covariates for that site. You also have access to one-week lagged versions of the climate variables to use if you choose.</p>
<p>The data set called tinyForecastingChallengeCovs.csv contains all of the covariates for the 5 time-steps that you need to forecast for.</p>
<p>When you have your forecasts, enter them here: <a href="https://forms.gle/TmMN7DxCJM45Zpq29">Beetle Forecasting Challenge Entry Form</a></p>
</section>
<section id="hints" class="level3">
<h3 class="anchored" data-anchor-id="hints">Hints</h3>
<ol type="1">
<li>Notice that the data set has an indicator variable that tells you whether or not there is an active sampling period going on, because when no sampling occurs we are assuming the number of beetles observed will always be 0. That makes these cases ‘special events’ - how can you take advantage of that information? <em>See slides 46-49</em></li>
</ol>


</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{arneson2024,
  author = {Arneson, Alicia},
  title = {VectorByte {Methods} {Training:} {Introduction} to {Time}
    {Series} {Forecasting} (Practical)},
  date = {2024-07-01},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-arneson2024" class="csl-entry quarto-appendix-citeas" role="listitem">
Arneson, Alicia. 2024. <span>“VectorByte Methods Training: Introduction
to Time Series Forecasting (Practical).”</span> July 1, 2024.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>